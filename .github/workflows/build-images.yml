name: Build Docker Images

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      custom_model:
        description: 'Custom model ID to build (optional)'
        required: false
        type: string
      custom_tag:
        description: 'Custom tag suffix (e.g., "my-model" creates "my-model-latest")'
        required: false
        type: string
        default: 'custom'
      hf_token_required:
        description: 'Does this model require HF token?'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Define the predefined models
  setup:
    runs-on: ubuntu-latest
    outputs:
      models: ${{ steps.models.outputs.models }}
      custom_model: ${{ steps.custom.outputs.model }}
      date_tag: ${{ steps.date.outputs.date }}
    steps:
      - name: Set date tag
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
      
      - name: Set predefined models
        id: models
        run: |
          # Define your predefined models here
          MODELS='[{"model_id":"google/gemma-3-270m-it","requires_token":true,"tag_suffix":"gemma-3-270m-it"},{"model_id":"meta-llama/Llama-3.2-1B-Instruct","requires_token":true,"tag_suffix":"llama-3.2-1b"},{"model_id":"Qwen/Qwen3-4B","requires_token":false,"tag_suffix":"qwen3-4b"},{"model_id":"Qwen/Qwen3-0.6B","requires_token":false,"tag_suffix":"qwen3-0.6b"},{"model_id":"Qwen/Qwen3-8B","requires_token":false,"tag_suffix":"qwen3-8b"}]'
          echo "models=${MODELS}" >> $GITHUB_OUTPUT
      
      - name: Set custom model
        id: custom
        run: |
          if [ -n "${{ inputs.custom_model }}" ]; then
            TAG_SUFFIX="${{ inputs.custom_tag }}"
            if [ -z "$TAG_SUFFIX" ]; then
              TAG_SUFFIX="custom"
            fi
            CUSTOM_MODEL='{"model_id":"${{ inputs.custom_model }}","requires_token":${{ inputs.hf_token_required }},"tag_suffix":"'$TAG_SUFFIX'"}'
            echo "model=${CUSTOM_MODEL}" >> $GITHUB_OUTPUT
          else
            echo "model=" >> $GITHUB_OUTPUT
          fi

  # Build predefined models (only on push to main, not manual dispatch)
  build-predefined:
    if: github.event_name == 'push'
    needs: setup
    strategy:
      matrix:
        model: ${{ fromJson(needs.setup.outputs.models) }}
      fail-fast: false
    uses: ./.github/workflows/build-single-image.yml
    with:
      model_id: ${{ matrix.model.model_id }}
      tag_suffix: ${{ matrix.model.tag_suffix }}
      date_tag: ${{ needs.setup.outputs.date_tag }}
      requires_token: ${{ matrix.model.requires_token }}
    secrets:
      hf_token: ${{ secrets.HF_TOKEN }}

  # Build custom model (only on manual dispatch)
  build-custom:
    if: github.event_name == 'workflow_dispatch' && inputs.custom_model != ''
    needs: setup
    uses: ./.github/workflows/build-single-image.yml
    with:
      model_id: ${{ fromJson(needs.setup.outputs.custom_model).model_id }}
      tag_suffix: ${{ fromJson(needs.setup.outputs.custom_model).tag_suffix }}
      date_tag: ${{ needs.setup.outputs.date_tag }}
      requires_token: ${{ fromJson(needs.setup.outputs.custom_model).requires_token }}
    secrets:
      hf_token: ${{ secrets.HF_TOKEN }}